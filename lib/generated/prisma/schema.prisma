// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Session {
  id             String   @id
  expiresAt      DateTime
  token          String   @unique
  createdAt      DateTime
  updatedAt      DateTime
  ipAddress      String?
  userAgent      String?
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  impersonatedBy String?

  @@map("session")
}

model User {
  id            String    @id
  name          String
  email         String    @unique
  emailVerified Boolean
  image         String?
  createdAt     DateTime
  updatedAt     DateTime
  role          String?
  banned        Boolean?
  banReason     String?
  banExpires    DateTime?
  sessions      Session[]
  accounts      Account[]

  properties      Property[]
  investorLeads   InvestorLead[]
  rentalLeads     RentalLead[]    @relation("RentalLeadAssignee")
  blogs           Blog[]
  rentalBookings  RentalBooking[]
  bookingsAsAgent RentalBooking[] @relation("BookingAgent")

  @@map("user")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

// Agent Invite Codes - For agent registration
model AgentInvite {
  id    String  @id @default(cuid())
  code  String  @unique // The invite code (e.g., "AGENT-ABC123")
  email String? // Optional: restrict to specific email
  role  String  @default("AGENT") // AGENT or ADMIN

  // Usage tracking
  maxUses   Int       @default(1) // How many times this code can be used
  usedCount Int       @default(0) // How many times it has been used
  usedBy    String? // User ID who used it (for single-use codes)
  usedAt    DateTime? // When it was used

  // Validity
  expiresAt DateTime? // Optional expiration date
  isActive  Boolean   @default(true)

  // Metadata
  createdBy String // Admin user ID who created the invite
  note      String? // Optional note about who this invite is for

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([email])
  @@index([isActive])
  @@map("agent_invite")
}

model Property {
  id            String  @id @default(cuid())
  listingNumber String? @unique // Unique listing number for easy reference (e.g., "PP-0001")
  title         String
  slug          String  @unique
  location      String
  price         String
  beds          Int
  baths         Float
  sqft          Int
  plotSize      Int? // Land/plot size in m¬≤ (optional, mainly for villas/houses)

  // Property classification
  type          PropertyType
  category      PropertyCategory @default(RESIDENTIAL_HOME)
  tag           String?
  status        Status           @default(ACTIVE)
  isHighlighted Boolean          @default(false) // Show in hero section on homepage

  // Ownership details (only for FOR_SALE properties)
  ownershipType OwnershipType? // FREEHOLD or LEASEHOLD - null means not specified
  isResale      Boolean?       @default(false) // True if property is a re-sale

  // Images - Main image kept for backward compatibility
  image  String
  images PropertyImage[]
  views  PropertyView[]

  // Content
  shortDescription      String? @db.Text
  descriptionParagraphs Json? // Array of description paragraphs

  // Property highlights/features
  propertyFeatures Json? // Array of {title, description, icon}

  // Amenities (kept as string array for now, can add relation later)
  amenities          String[]
  amenitiesWithIcons Json? // Array of {name, icon}

  // Additional metadata
  content   String  @db.Text // Kept for backward compatibility
  yearBuilt Int?
  mapUrl    String?

  // Daily rental pricing
  monthlyRentalPrice Float? // Monthly rental price (used to calculate daily rates)
  allowPets          Boolean @default(false) // Allow pets in the property
  enableDailyRental  Boolean @default(false) // Enable daily rental for this property
  maxGuests          Int? // Maximum number of guests for daily rental

  // URL slugs for SEO-friendly URLs
  provinceSlug String? // e.g., "phuket"
  areaSlug     String? // e.g., "rawai"

  // Owner contact information (legacy - prefer PropertyOwner relation)
  ownerName        String?
  ownerEmail       String?
  ownerPhone       String?
  ownerCountryCode String? @default("+66")
  ownerCompany     String?
  ownerNotes       String? @db.Text

  // Property Owner relation (new centralized system)
  propertyOwnerId String?        @map("property_owner_id")
  propertyOwner   PropertyOwner? @relation("PropertyOwner", fields: [propertyOwnerId], references: [id])

  // Bluebook for this property (linked via OwnerDocument)
  bluebookUrl     String? @map("bluebook_url")
  bluebookHouseId String? @map("bluebook_house_id") // "123/45" from OCR

  // Commission rate for the property
  commissionRate Float? @default(3.0)

  // ============================================
  // TM30 THAILAND IMMIGRATION
  // ============================================
  tm30AccommodationId   String? @map("tm30_accommodation_id") // ID/naam in TM30 systeem
  tm30AccommodationName String? @map("tm30_accommodation_name") // Volledige naam voor display

  // ============================================
  // PROPERTY ACCESS DEFAULTS (for rental bookings)
  // ============================================
  defaultCheckInTime          String? @default("14:00") @map("default_check_in_time")
  defaultCheckOutTime         String? @default("11:00") @map("default_check_out_time")
  defaultPropertyAddress      String? @map("default_property_address") @db.Text
  defaultWifiName             String? @map("default_wifi_name")
  defaultWifiPassword         String? @map("default_wifi_password")
  defaultAccessCode           String? @map("default_access_code")
  defaultEmergencyContact     String? @map("default_emergency_contact")
  defaultPropertyInstructions String? @map("default_property_instructions") @db.Text
  defaultHouseRules           String? @map("default_house_rules") @db.Text

  // ============================================
  // GEO & POI DATA
  // ============================================

  // Geo-co√∂rdinaten (voor POI distance berekeningen en kaart)
  latitude  Float?
  longitude Float?

  // Pre-calculated location scores (0-100, higher = better)
  beachScore       Int? // Nabijheid tot stranden
  familyScore      Int? // Scholen, ziekenhuizen in de buurt
  convenienceScore Int? // Supermarkten, winkels, etc.
  quietnessScore   Int? // Afstand tot drukke wegen/nightlife

  // Sea view analyse
  hasSeaView       Boolean @default(false)
  seaViewDirection String? // N, NE, E, SE, S, SW, W, NW
  seaDistance      Int? // Meters tot dichtstbijzijnde kust

  // District voor filtering (genormaliseerd)
  district String? // Rawai, Kata, Chalong, Patong, etc.

  // POI sync tracking
  poisLastCalculatedAt DateTime?

  // Relations - POI distances
  poiDistances PropertyPoiDistance[]

  // Relations
  userId            String
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  viewingRequests   ViewingRequest[]
  rentalBookings    RentalBooking[]
  blockedDates      PropertyBlockedDate[]
  tm30Accommodation Tm30Accommodation? // Linked TM30 registration

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([latitude, longitude])
  @@index([district])
  @@index([beachScore])
  @@index([familyScore])
  @@index([convenienceScore])
  @@map("property")
}

model PropertyImage {
  id         String   @id @default(cuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  url      String? // Nullable - null means slot is empty, filled means image is uploaded
  position Int // 1=hero (large left), 2=top-right, 3=bottom-left, 4=bottom-right
  alt      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([propertyId, position])
  @@map("property_image")
}

// Property Views - Track views on properties for analytics
model PropertyView {
  id         String   @id @default(cuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  viewedAt DateTime @default(now())
  country  String? // Country code of the viewer (e.g., "US", "NL", "TH")
  city     String? // City of the viewer

  // Optional metadata for more detailed analytics
  ipHash    String? // Hashed IP for privacy
  userAgent String?
  referrer  String?
  sessionId String?

  @@index([propertyId])
  @@index([viewedAt])
  @@index([country])
  @@map("property_view")
}

enum PropertyType {
  FOR_SALE
  FOR_RENT
}

enum OwnershipType {
  FREEHOLD
  LEASEHOLD
}

enum PropertyCategory {
  LUXURY_VILLA
  APARTMENT
  RESIDENTIAL_HOME
  OFFICE_SPACES
}

enum Status {
  ACTIVE
  INACTIVE
  SOLD
  RENTED
}

model ViewingRequest {
  id         String    @id @default(cuid())
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  // Request details
  requestType RequestType
  viewingDate DateTime? // Optional, only for SCHEDULE_VIEWING

  // Contact information
  name        String
  email       String
  phone       String
  countryCode String  @default("+66")
  language    String?
  message     String? @db.Text

  // Offer details (only for MAKE_OFFER type)
  offerAmount   String? // The offered price (e.g., "15500000" or "‡∏ø15,500,000")
  offerCurrency String? @default("THB")

  // Request status
  status RequestStatus @default(PENDING)

  // Agent tracking
  confirmedBy     String? // User ID of agent who confirmed
  confirmedByName String? // Name of agent who confirmed
  confirmedAt     DateTime? // When it was confirmed
  completedBy     String? // User ID of agent who marked as complete
  completedByName String? // Name of agent who marked as complete
  completedAt     DateTime? // When it was completed
  cancelledBy     String? // User ID of agent who cancelled
  cancelledByName String? // Name of agent who cancelled
  cancelledAt     DateTime? // When it was cancelled

  // Metadata
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("viewing_request")
}

enum RequestType {
  SCHEDULE_VIEWING
  MAKE_OFFER
}

enum RequestStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

model InvestorLead {
  id String @id @default(cuid())

  // Personal Information
  name        String
  email       String
  phone       String
  countryCode String @default("+66")
  currency    String @default("EUR") // EUR, USD, GBP, THB, AUD

  // Investment Profile
  investmentBudget String // Range: 50k-200k, 200k-500k, 500k-1m, 1m+
  investmentGoal   String // buy-hold, fix-flip, rental-income, vacation-home, diversification
  timeline         String // immediate, 3-6months, 6-12months, 12+months
  preferredAreas   String? // Comma-separated: phuket, pattaya, bangkok, etc.
  propertyType     String? // villa, apartment, commercial, land

  // Additional Context
  experience String? // first-time, 1-3properties, 4-10properties, 10+properties
  financing  String? // cash, mortgage, mixed
  message    String? @db.Text

  // Marketing Consent
  newsletter Boolean @default(true)

  // Lead Status & Tracking
  status       LeadStatus @default(NEW)
  assignedToId String?
  assignedTo   User?      @relation(fields: [assignedToId], references: [id])

  // Metadata
  ipAddress String?
  userAgent String?
  source    String? // landing-page, blog, referral, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("investor_lead")
}

model RentalLead {
  id String @id @default(cuid())

  // Personal Information
  name        String
  email       String
  phone       String
  countryCode String @default("+66")

  // Rental Requirements
  propertyType   String // villa, apartment, condo, house
  bedrooms       String // 1, 2, 3, 4, 5+
  budget         String // Range: under-20k, 20k-40k, 40k-60k, 60k-100k, 100k+
  rentalDuration String // short-term, 6-12months, 1-2years, 2+years
  preferredAreas String? // Comma-separated: rawai, kata, patong, etc.

  // Additional Requirements
  moveInDate String? // immediate, 1month, 2-3months, flexible
  furnished  String? // yes, no, partial
  pets       String? // yes, no
  message    String? @db.Text

  // Marketing Consent
  newsletter Boolean @default(true)

  // Lead Status & Tracking
  status       RentalLeadStatus @default(NEW)
  assignedToId String?
  assignedTo   User?            @relation("RentalLeadAssignee", fields: [assignedToId], references: [id])

  // Metadata
  ipAddress String?
  userAgent String?
  source    String? // rental-page, property-detail, referral, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("rental_lead")
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  CONVERTED
  NOT_INTERESTED
  LOST
}

enum RentalLeadStatus {
  NEW
  CONTACTED
  VIEWING_SCHEDULED
  OFFER_MADE
  RENTED
  NOT_INTERESTED
  LOST
}

model Blog {
  id            String  @id @default(cuid())
  title         String
  slug          String  @unique
  excerpt       String  @db.Text
  content       String  @db.Text
  coverImage    String?
  coverImageAlt String? // Alt text for cover image (SEO)
  tag           String?

  // SEO fields
  metaTitle       String?
  metaDescription String? @db.Text

  // Category (for SEO structure)
  categoryId String?
  category   BlogCategory? @relation(fields: [categoryId], references: [id])

  // Status
  published   Boolean   @default(false)
  publishedAt DateTime?

  // Link Optimization (for retroactive linking)
  originalContent   String?   @db.Text // Backup of content before link optimization
  linkOptimizedAt   DateTime? // When links were last optimized
  internalLinkCount Int       @default(0) // Number of internal links in content

  // Dynamic properties for POI-based content
  hasDynamicProperties Boolean @default(false) @map("has_dynamic_properties")
  poiQueryParams       String? @map("poi_query_params") @db.Text
  poiTemplateId        String? @map("poi_template_id")

  // Link usage tracking
  linkUsages LinkUsage[]

  // Author relation
  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([published])
  @@index([createdAt])
  @@index([categoryId])
  @@index([linkOptimizedAt])
  @@map("blog")
}

// Blog Categories - For structured content organization (SEO)
model BlogCategory {
  id String @id @default(cuid())

  // Basic info
  name        String // Display name (e.g., "Investment Guide")
  slug        String  @unique // URL slug (e.g., "investment-guide")
  description String? @db.Text // Category description for SEO

  // Hierarchy (tree structure)
  parentId String?
  parent   BlogCategory?  @relation("CategoryTree", fields: [parentId], references: [id])
  children BlogCategory[] @relation("CategoryTree")

  // SEO
  metaTitle       String?
  metaDescription String? @db.Text

  // Display
  icon  String? // Lucide icon name or emoji
  color String? // Hex color for UI
  order Int     @default(0) // Display order

  // Status
  isActive Boolean @default(true)

  // Relations
  blogs Blog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([isActive])
  @@map("blog_category")
}

// Property Owner Submissions - for owners who want to list their property
model PropertySubmission {
  id String @id @default(cuid())

  // Owner Information
  ownerName        String
  ownerEmail       String
  ownerPhone       String
  ownerCountryCode String @default("+66")

  // Access token for owner to view/edit their submission (no login required)
  accessToken String @unique @default(cuid())

  // Property Details
  propertyTitle    String
  propertyCategory PropertyCategory
  propertyType     PropertyType // FOR_SALE or FOR_RENT
  location         String
  askingPrice      String
  beds             Int
  baths            Float
  sqft             Int
  description      String           @db.Text

  // Property Images (URLs - added after approval)
  images String[] // Array of image URLs

  // Listing Agreement
  exclusiveRights   Boolean @default(false)
  commissionRate    Float   @default(3.0) // Standard 3%, Exclusive 15%+
  agreementAccepted Boolean @default(false)

  // Submission Status
  status SubmissionStatus @default(PENDING_REVIEW)

  // Admin Review
  reviewNotes    String?   @db.Text
  reviewedBy     String?
  reviewedByName String?
  reviewedAt     DateTime?

  // Images Approval
  imagesApprovedAt DateTime?
  imagesApprovedBy String?

  // Final Publication
  publishedAt DateTime?
  publishedBy String?

  // Converted to Property (when published)
  convertedPropertyId String?

  // Metadata
  ipAddress String?
  userAgent String?
  source    String? // website, referral, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerEmail])
  @@index([status])
  @@index([accessToken])
  @@index([createdAt])
  @@map("property_submission")
}

enum SubmissionStatus {
  PENDING_REVIEW // Initial submission, waiting for admin review
  UNDER_REVIEW // Admin is reviewing
  INFO_REQUESTED // Admin requested more info from owner
  APPROVED // Approved - owner can now upload images
  IMAGES_UPLOADED // Owner has uploaded images, waiting for final approval
  READY_TO_PUBLISH // All approved, ready to be published
  PUBLISHED // Live on the website
  REJECTED // Rejected by admin
}

// Site Settings - for storing configuration like SMTP, etc.
model SiteSettings {
  id String @id @default("default") // Single row with id "default"

  // SMTP Configuration
  smtpHost      String?
  smtpPort      Int?    @default(587)
  smtpSecure    Boolean @default(false)
  smtpUser      String?
  smtpPassword  String? // Encrypted in production
  smtpFromName  String? @default("Real Estate Pulse")
  smtpFromEmail String?

  // General Settings
  siteName  String? @default("Real Estate Pulse")
  siteEmail String? // Contact email for the site

  // Admin Notifications
  adminNotifyEmail    String? // Email to notify when new submissions arrive
  notifyOnSubmission  Boolean @default(true)
  notifyOnImageUpload Boolean @default(true)

  // AI Content Generation Settings
  companyDescription String? @db.Text // Detailed description of the company
  companyTone        String? @default("professional") // professional, friendly, luxury, casual
  companyUSPs        String? @db.Text // Unique Selling Points (JSON array)
  targetAudience     String? @db.Text // Target audience description
  brandKeywords      String? @db.Text // Keywords to include often (comma-separated)
  avoidTopics        String? @db.Text // Topics to avoid mentioning

  // Website Scanner Settings
  websiteUrl        String? // Main website URL to scan
  lastScannedAt     DateTime? // When the website was last scanned
  scannedPagesCount Int? // Number of pages analyzed
  scanConfidence    Float? // AI confidence score (0-1)
  detectedThemes    String?   @db.Text // JSON array of detected content themes

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("site_settings")
}

// Internal Links for Blog Posts - URLs that can be linked to in generated content
model InternalLink {
  id String @id @default(cuid())

  url         String // Full URL path (e.g., /properties/luxury-villa-kata)
  title       String // Anchor text suggestion
  description String? @db.Text // What this page is about

  // Enhanced categorization
  category    String? // Category: property, service, page, blog, location, guide
  subCategory String? // Sub-category for more specific linking (e.g., "buying", "selling", "rental")

  keywords    String? @db.Text // Keywords this link is relevant for (comma-separated)
  anchorTexts String? @db.Text // JSON array of suggested anchor text variations
  priority    Int     @default(1) // 1-5, higher = more important to link to

  isActive   Boolean @default(true)
  usageCount Int     @default(0) // Track how often this link is used

  // Page existence validation
  pageExists  Boolean   @default(true) // Whether the target page actually exists
  lastChecked DateTime? // When the page was last validated

  // Relations
  usages LinkUsage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([url])
  @@index([category])
  @@index([isActive])
  @@index([pageExists])
  @@map("internal_link")
}

// Track where internal links are used in blogs
model LinkUsage {
  id String @id @default(cuid())

  // Link reference
  linkId String
  link   InternalLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

  // Blog reference
  blogId String
  blog   Blog   @relation(fields: [blogId], references: [id], onDelete: Cascade)

  // Usage details
  anchorText String // The anchor text that was used
  context    String? @db.Text // Surrounding text for context (50 chars before/after)
  position   Int? // Approximate position in content (character index)

  // Tracking
  wasAutoInserted Boolean  @default(false) // Whether inserted by retroactive system
  insertedAt      DateTime @default(now())

  createdAt DateTime @default(now())

  @@index([linkId])
  @@index([blogId])
  @@map("link_usage")
}

// Suggestions for landing pages that should be created
model LandingPageSuggestion {
  id String @id @default(cuid())

  // Suggested page details
  suggestedUrl   String // /diensten/dubai-investment-guide
  suggestedTitle String // "Dubai Investment Guide"
  description    String? @db.Text // What this page should contain

  // Categorization
  category String // service, guide, location, faq

  // Why this page is needed
  reason String? @db.Text // AI explanation of why this page would be valuable

  // Tracking frequency
  mentionCount Int     @default(1) // How often this topic appears in blogs
  sourceBlogs  String? @db.Text // JSON array of blog IDs where this topic is mentioned

  // Status workflow
  status LandingPageStatus @default(PENDING)

  // When the page was actually created
  createdPageUrl String? // Actual URL if page was created
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([suggestedUrl])
  @@index([status])
  @@index([mentionCount])
  @@map("landing_page_suggestion")
}

enum LandingPageStatus {
  PENDING // Suggested but not reviewed
  APPROVED // Approved for creation
  CREATED // Landing page has been created
  DISMISSED // Dismissed as not needed
}

// Generated Landing Pages - DB-backed pages created from AI suggestions
model LandingPage {
  id String @id @default(cuid())

  // Full path including leading slash (e.g. /diensten/legal-advisory-thailand)
  url String @unique

  // Content & SEO
  title           String
  category        String // service|guide|location|faq (or custom)
  metaTitle       String?
  metaDescription String? @db.Text
  content         String  @db.Text // sanitized on render via HTMLContent
  faq             Json? // Array<{question, answer}> for FAQ schema

  // Publication
  published Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([published])
  @@map("landing_page")
}

// Company Profile - Detailed company information for AI content generation
model CompanyProfile {
  id String @id @default("default")

  // Basic Info
  companyName String?
  tagline     String?
  description String? @db.Text

  // Brand Voice
  tone         String? @default("professional") // professional, friendly, luxury, educational
  writingStyle String? @db.Text // Additional writing style notes

  // Target Market
  targetAudience  String? @db.Text
  targetLocations String? @db.Text // Geographic focus (JSON array)

  // USPs & Differentiators
  usps      String? @db.Text // JSON array of unique selling points
  expertise String? @db.Text // Areas of expertise

  // Content Strategy
  contentThemes String? @db.Text // JSON array of main content themes
  brandKeywords String? @db.Text // Keywords to always include
  avoidTopics   String? @db.Text // Topics to never mention
  competitors   String? @db.Text // Competitors to be aware of

  // Website Analysis Results
  websiteUrl     String?
  lastAnalyzedAt DateTime?
  analysisData   String?   @db.Text // Full JSON of analysis results

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("company_profile")
}

// Blog Schedule Settings - Separate table for scheduling configuration
model BlogScheduleSettings {
  id String @id @default("default")

  // SEO-based limits (from research: 1-3 posts/week optimal for small/medium sites)
  maxBlogsPerWeek     Int     @default(3) // Max blogs allowed per week
  minDaysBetweenPosts Int     @default(2) // Minimum days between posts
  preferredPostTime   String? @default("09:00") // Preferred time to auto-publish (HH:mm)
  preferredPostDays   String? @db.Text // JSON array of preferred days ["Monday", "Wednesday", "Friday"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("blog_schedule_settings")
}

// Topic Suggestions - Store generated topics with usage tracking
model TopicSuggestion {
  id String @id @default(cuid())

  // Topic content
  title           String
  description     String? @db.Text
  category        String? // investment, lifestyle, legal, market, guide, news
  priority        String? // trending, evergreen, seasonal
  difficulty      String? // easy, medium, hard
  estimatedImpact String? // high, medium, low
  language        String  @default("en")

  // Status tracking
  status          TopicStatus @default(AVAILABLE)
  usedAt          DateTime? // When topic was used to generate a blog
  generatedBlogId String? // Reference to the blog if generated

  // Generation batch tracking
  batchId String? // Group topics from same generation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([batchId])
  @@index([language])
  @@map("topic_suggestion")
}

enum TopicStatus {
  AVAILABLE // Not yet used
  SCHEDULED // Scheduled for future blog
  USED // Already generated into a blog
  SKIPPED // Manually skipped by user
}

// Scheduled Blogs - For calendar scheduling and auto-publishing
model ScheduledBlog {
  id String @id @default(cuid())

  // Content (either from topic or custom)
  topicId    String? // Reference to TopicSuggestion if from discover
  topicTitle String // Title/topic for the blog

  // Generation settings (stored for when blog is generated)
  language        String  @default("en")
  length          String  @default("medium") // short, medium, long
  tone            String  @default("professional")
  includeResearch Boolean @default(true)

  // Scheduling
  scheduledFor DateTime // When to auto-publish
  scheduledBy  String // User ID who scheduled

  // Status
  status ScheduledBlogStatus @default(SCHEDULED)

  // Generated blog reference
  generatedBlogId String? // Blog ID after generation

  // Processing tracking
  processingStartedAt DateTime?
  processedAt         DateTime?
  errorMessage        String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scheduledFor])
  @@index([status])
  @@map("scheduled_blog")
}

enum ScheduledBlogStatus {
  SCHEDULED // Waiting to be processed
  PROCESSING // Currently being generated
  COMPLETED // Successfully generated and published
  FAILED // Generation failed
  CANCELLED // Manually cancelled
}

// Hero Images - Dynamic hero images for different device types and pages
model HeroImage {
  id String @id @default(cuid())

  // Image identification
  page       String         @default("home") // Which page this hero is for (home, properties, etc.)
  deviceType HeroDeviceType // desktop, mobile, tablet

  // Image data
  imageUrl String // ImageKit URL
  alt      String // SEO-optimized alt text
  fileName String? // Original/generated filename

  // Original image backup (for restore functionality)
  originalUrl String? // Original static image URL to restore to

  // Image metadata for SEO
  width  Int?
  height Int?

  // Generation info
  isAiGenerated Boolean @default(false)
  aiPrompt      String? @db.Text // If AI generated, the prompt used

  // Optimization stats
  originalSize  Int? // Original file size in bytes
  optimizedSize Int? // Compressed file size in bytes

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([page, deviceType])
  @@index([page])
  @@index([isActive])
  @@map("hero_image")
}

enum HeroDeviceType {
  DESKTOP
  MOBILE
  TABLET
}

// Property Alerts - Users can subscribe to be notified when new properties match their criteria
model PropertyAlert {
  id String @id @default(cuid())

  // Contact Information
  email       String
  name        String?
  phone       String?
  countryCode String  @default("+66")

  // Optional user relation (if logged in when creating)
  userId String?

  // Filter Criteria
  propertyType PropertyType? // FOR_SALE or FOR_RENT (null = both)
  category     PropertyCategory? // LUXURY_VILLA, APARTMENT, etc. (null = all)

  // Location Filter
  locations String? @db.Text // JSON array of location strings ["Rawai", "Kata", "Patong"]

  // Price Range (stored as numbers for comparison)
  minPrice Int? // Minimum price in THB
  maxPrice Int? // Maximum price in THB

  // Bedrooms Filter
  minBeds Int?
  maxBeds Int?

  // Bathrooms Filter
  minBaths Int?
  maxBaths Int?

  // Size Filter (sqm)
  minSqft Int?
  maxSqft Int?

  // Notification Preferences
  notifyImmediately Boolean @default(true) // Notify as soon as property is added
  notifyDigest      Boolean @default(false) // Weekly digest of matching properties
  digestDay         String? @default("Monday") // Day for weekly digest

  // Status & Tracking
  isActive          Boolean   @default(true)
  lastNotifiedAt    DateTime? // When last notification was sent
  matchCount        Int       @default(0) // Total properties matched
  notificationCount Int       @default(0) // Total notifications sent

  // Verification (for non-logged-in users)
  verificationToken String?   @unique
  isVerified        Boolean   @default(false)
  verifiedAt        DateTime?

  // Unsubscribe token
  unsubscribeToken String @unique @default(cuid())

  // Metadata
  ipAddress String?
  userAgent String?
  source    String? // property-page, search-page, footer, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([isActive])
  @@index([propertyType])
  @@index([createdAt])
  @@map("property_alert")
}

// Property Alert Notifications - Track sent notifications
model PropertyAlertNotification {
  id String @id @default(cuid())

  // Alert reference
  alertId String

  // Properties matched
  propertyIds   String @db.Text // JSON array of property IDs included
  propertyCount Int // Number of properties in this notification

  // Email details
  emailSent   Boolean   @default(false)
  emailSentAt DateTime?
  emailError  String?   @db.Text

  // Tracking
  opened    Boolean   @default(false)
  openedAt  DateTime?
  clicked   Boolean   @default(false)
  clickedAt DateTime?

  createdAt DateTime @default(now())

  @@index([alertId])
  @@index([createdAt])
  @@map("property_alert_notification")
}

// ============================================
// POI SYSTEEM - Points of Interest
// ============================================

// Hoofdtabel voor alle Points of Interest
model Poi {
  id String @id @default(cuid())

  // Identificatie - voor deduplicatie
  externalId String? // OSM node ID of Google place_id
  source     PoiSource @default(OSM)

  // Basis info
  name      String
  nameTh    String? // Thai naam
  nameLocal String? // Lokale naam variant

  // Categorisatie
  category    PoiCategory
  subCategory String? // Meer specifiek: "international_school", "private_hospital"

  // Locatie
  latitude  Float
  longitude Float
  address   String?
  district  String? // Rawai, Kata, Chalong, Patong, etc.

  // Metadata van bron
  osmTags Json? // Originele OSM tags voor debugging/filtering

  // Kwaliteit & ranking
  importance Int     @default(5) // 1-10, voor ranking in UI
  isVerified Boolean @default(false) // Handmatig geverifieerd
  isActive   Boolean @default(true)

  // Voor noise/traffic proxies
  noiseLevel   NoiseLevel?
  trafficLevel TrafficLevel?

  // Sync tracking
  lastSyncedAt DateTime?
  syncError    String?

  // Relations
  propertyDistances PropertyPoiDistance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([externalId, source])
  @@index([category])
  @@index([subCategory])
  @@index([district])
  @@index([latitude, longitude])
  @@index([isActive])
  @@map("poi")
}

// Pre-berekende afstanden tussen properties en POIs
model PropertyPoiDistance {
  id String @id @default(cuid())

  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  poiId String
  poi   Poi    @relation(fields: [poiId], references: [id], onDelete: Cascade)

  // Afstanden
  distanceMeters Int // Hemelsbreed (Haversine)
  walkingMinutes Int? // Via routing API (optioneel)
  drivingMinutes Int? // Via routing API (optioneel)

  // Relevantie voor UI
  isHighlight Boolean @default(false) // Toon prominent op listing

  calculatedAt DateTime @default(now())

  @@unique([propertyId, poiId])
  @@index([propertyId])
  @@index([poiId])
  @@index([distanceMeters])
  @@map("property_poi_distance")
}

// POI Sync Job tracking
model PoiSyncJob {
  id String @id @default(cuid())

  // Job info
  jobType PoiSyncJobType
  status  PoiSyncJobStatus @default(PENDING)

  // Scope
  category PoiCategory? // Null = all categories
  district String? // Null = all districts

  // Results
  poisFetched Int @default(0)
  poisCreated Int @default(0)
  poisUpdated Int @default(0)
  poisSkipped Int @default(0)

  // Timing
  startedAt   DateTime?
  completedAt DateTime?

  // Error handling
  errorMessage String? @db.Text
  errorStack   String? @db.Text

  createdAt DateTime @default(now())

  @@index([status])
  @@index([createdAt])
  @@map("poi_sync_job")
}

// ============================================
// POI ENUMS
// ============================================

enum PoiSource {
  OSM // OpenStreetMap via Overpass API
  GOOGLE // Google Places API
  MANUAL // Handmatig toegevoegd door admin
  GOVERNMENT // Offici√´le overheidsbronnen
}

enum PoiCategory {
  // üèñÔ∏è Leisure
  BEACH
  PARK
  VIEWPOINT
  GOLF_COURSE
  MARINA
  TEMPLE

  // üè´ Family & Education
  INTERNATIONAL_SCHOOL
  LOCAL_SCHOOL
  KINDERGARTEN
  UNIVERSITY

  // üè• Healthcare
  HOSPITAL
  CLINIC
  PHARMACY
  DENTIST

  // üèôÔ∏è Daily Life - Shopping
  SHOPPING_MALL
  SUPERMARKET
  CONVENIENCE_STORE
  MARKET

  // üèôÔ∏è Daily Life - Services
  GYM
  COWORKING
  BANK
  ATM
  POST_OFFICE

  // üçΩÔ∏è Food & Drink
  RESTAURANT
  CAFE
  BAR
  NIGHTCLUB

  // üö¶ Transport & Infrastructure
  MAIN_ROAD
  HIGHWAY_ACCESS
  AIRPORT
  BUS_STATION
  FERRY_TERMINAL
  TAXI_STAND

  // üåä Environment & Views
  SEA_VIEW_POINT
  MOUNTAIN_VIEW
  RIVER
  LAKE

  // üîá Noise Indicators
  NIGHTLIFE_CLUSTER
  BUSY_INTERSECTION
  CONSTRUCTION_ZONE

  // üß± Areas & Districts
  NEIGHBORHOOD
  TOURIST_AREA
  RESIDENTIAL_AREA

  // üè® Accommodation (for reference)
  HOTEL
  RESORT
}

enum NoiseLevel {
  QUIET // Residentieel, ver van wegen
  MODERATE // Normale straten
  BUSY // Drukke wegen, winkels
  LOUD // Nightlife, hoofdwegen
}

enum TrafficLevel {
  LOW
  MEDIUM
  HIGH
  VERY_HIGH
}

enum PoiSyncJobType {
  FULL_SYNC // Alle POIs voor hele regio
  CATEGORY_SYNC // Specifieke categorie
  DISTRICT_SYNC // Specifiek district
  INCREMENTAL // Alleen nieuwe/gewijzigde
}

enum PoiSyncJobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================
// RENTAL PRICING & BOOKING SYSTEM
// ============================================

model RentalPricingConfig {
  id String @id @default("default")

  peakSeasonMonths     Int[] @default([12, 1, 2])
  peakSeasonSurcharges Json  @default("[{\"minDays\":1,\"maxDays\":7,\"surchargePercent\":30},{\"minDays\":8,\"maxDays\":14,\"surchargePercent\":20},{\"minDays\":15,\"maxDays\":19,\"surchargePercent\":15},{\"minDays\":20,\"maxDays\":30,\"surchargePercent\":0}]")
  lowSeasonSurcharges  Json  @default("[{\"minDays\":1,\"maxDays\":7,\"surchargePercent\":20},{\"minDays\":8,\"maxDays\":14,\"surchargePercent\":17},{\"minDays\":15,\"maxDays\":19,\"surchargePercent\":13},{\"minDays\":20,\"maxDays\":30,\"surchargePercent\":0}]")
  minimumStayDays      Int   @default(1)
  maximumStayDays      Int   @default(30)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("rental_pricing_config")
}

model RentalBooking {
  id         String   @id @default(cuid())
  propertyId String
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  // User who made the booking (required - must be logged in)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Booking dates
  checkIn  DateTime
  checkOut DateTime
  nights   Int

  // Guest information
  adults   Int @default(1)
  children Int @default(0)
  babies   Int @default(0)
  pets     Int @default(0)

  // Pricing
  basePrice       Float
  season          String
  discountPercent Float
  totalPrice      Float

  // Guest contact information
  guestName        String
  guestEmail       String
  guestPhone       String
  guestCountryCode String  @default("+66")
  guestMessage     String? @db.Text

  // Booking status
  status        RentalBookingStatus @default(PENDING)
  paymentStatus String?

  // Cancellation
  cancellationPolicy String?
  cancelledAt        DateTime?
  cancellationReason String?   @db.Text

  // Internal notes
  internalNotes String? @db.Text

  // Property access details (filled in by agent after confirmation)
  checkInTime          String?   @default("14:00") @map("check_in_time")
  checkOutTime         String?   @default("11:00") @map("check_out_time")
  propertyAddress      String?   @map("property_address") @db.Text
  propertyInstructions String?   @map("property_instructions") @db.Text
  wifiName             String?   @map("wifi_name")
  wifiPassword         String?   @map("wifi_password")
  accessCode           String?   @map("access_code")
  emergencyContact     String?   @map("emergency_contact")
  houseRules           String?   @map("house_rules") @db.Text
  confirmedAt          DateTime? @map("confirmed_at")

  // Agent who confirmed the booking
  agentId String? @map("agent_id")
  agent   User?   @relation("BookingAgent", fields: [agentId], references: [id])

  // Messages
  messages BookingMessage[]

  // ============================================
  // TM30 THAILAND IMMIGRATION
  // ============================================
  tm30Status        TM30BookingStatus @default(PENDING) @map("tm30_status")
  tm30SubmittedAt   DateTime?         @map("tm30_submitted_at")
  tm30Reference     String?           @map("tm30_reference")
  tm30Error         String?           @map("tm30_error")
  passportsRequired Int               @default(0) @map("passports_required")
  passportsReceived Int               @default(0) @map("passports_received")

  // Guests (for passport/TM30 management)
  guests BookingGuest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([propertyId])
  @@index([userId])
  @@index([checkIn, checkOut])
  @@index([status])
  @@index([tm30Status])
  @@map("rental_booking")
}

model BookingMessage {
  id        String        @id @default(cuid())
  bookingId String        @map("booking_id")
  booking   RentalBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  senderId   String @map("sender_id")
  senderRole String @default("customer") @map("sender_role")

  message String  @db.Text
  isRead  Boolean @default(false) @map("is_read")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([bookingId])
  @@index([senderId])
  @@index([createdAt])
  @@map("booking_message")
}

enum RentalBookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum TM30BookingStatus {
  PENDING // Wacht op paspoort
  PASSPORT_RECEIVED // Paspoort ontvangen, wacht op check-in
  PROCESSING // TM30 wordt ingediend
  SUBMITTED // Succesvol ingediend
  FAILED // Fout bij indienen
}

enum TM30GuestStatus {
  PENDING // Wacht op paspoort
  SCANNED // OCR uitgevoerd
  VERIFIED // Door admin geverifieerd
  SUBMITTED // TM30 ingediend
  FAILED // Fout
}

// ============================================
// BOOKING GUEST (for TM30 passport management)
// ============================================
model BookingGuest {
  id        String        @id @default(cuid())
  bookingId String        @map("booking_id")
  booking   RentalBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  // Guest type
  guestType   String @default("adult") @map("guest_type") // adult, child, baby
  guestNumber Int    @default(1) @map("guest_number") // Guest 1, 2, 3, etc.

  // Personal details (extracted from passport via OCR)
  firstName   String?   @map("first_name")
  lastName    String?   @map("last_name")
  fullName    String?   @map("full_name") // Combined name for display
  dateOfBirth DateTime? @map("date_of_birth")
  nationality String?
  gender      String? // M/F

  // Passport details
  passportNumber    String?   @map("passport_number")
  passportExpiry    DateTime? @map("passport_expiry")
  passportIssueDate DateTime? @map("passport_issue_date")
  passportCountry   String?   @map("passport_country")

  // Passport scan
  passportImageUrl  String?   @map("passport_image_url")
  passportImagePath String?   @map("passport_image_path")
  ocrConfidence     Float?    @map("ocr_confidence")
  ocrRawData        Json?     @map("ocr_raw_data")
  ocrProcessedAt    DateTime? @map("ocr_processed_at")

  // Verification
  passportVerified Boolean   @default(false) @map("passport_verified")
  verifiedBy       String?   @map("verified_by")
  verifiedAt       DateTime? @map("verified_at")

  // TM30 status per guest
  tm30Status      TM30GuestStatus @default(PENDING) @map("tm30_status")
  tm30SubmittedAt DateTime?       @map("tm30_submitted_at")
  tm30Error       String?         @map("tm30_error")

  // WhatsApp conversation tracking
  whatsappMessageId  String?   @map("whatsapp_message_id")
  whatsappReceivedAt DateTime? @map("whatsapp_received_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([bookingId])
  @@index([passportNumber])
  @@index([tm30Status])
  @@map("booking_guest")
}

// Manually blocked dates for properties (admin can block dates)
model PropertyBlockedDate {
  id         String   @id @default(cuid())
  propertyId String   @map("property_id")
  property   Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  reason    String? // Optional reason for blocking (e.g., "Maintenance", "Owner use")

  // Who blocked it
  blockedBy String? @map("blocked_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([propertyId])
  @@index([startDate, endDate])
  @@map("property_blocked_date")
}

// ============================================
// TM30 ACCOMMODATION CACHE
// ============================================
// Cached TM30 accommodations from Thailand Immigration website
// Used for linking properties to their TM30 registration
model Tm30Accommodation {
  id String @id @default(cuid())

  // TM30 System Identifiers
  tm30Id  String @map("tm30_id") // Original ID from TM30 system
  name    String // Accommodation name in TM30
  address String @db.Text // Full address

  // Status in TM30 system
  status String? @default("Pending") // "Approved", "Pending", "Rejected"

  // Link to our property
  propertyId String?   @unique @map("property_id")
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  // Matching metadata
  matchScore Float?    @map("match_score")
  matchedBy  String?   @map("matched_by")
  matchedAt  DateTime? @map("matched_at")

  // Sync metadata
  lastSyncedAt DateTime? @map("last_synced_at")
  syncSource   String?   @map("sync_source")
  createdAt    DateTime? @default(now()) @map("created_at")
  updatedAt    DateTime? @updatedAt @map("updated_at")

  @@index([name])
  @@index([status])
  @@index([propertyId])
  @@map("tm30_accommodation")
}

// ============================================
// TM30 ACCOMMODATION REGISTRATION REQUEST
// For adding NEW accommodations to TM30 system
// Data can come from OCR of ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô (house registration)
// ============================================
model Tm30AccommodationRequest {
  id String @id @default(cuid())

  // ============================================
  // EIGENAAR INFORMATIE (Owner / ‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô)
  // ============================================
  // If checkbox "‡πÄ‡∏à‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" is checked, 
  // these are copied from the TM30 profile (RUEDEEKORN's data)
  ownerSameAsRegistrant Boolean @default(true) @map("owner_same_as_registrant")
  ownerNationalType     String  @default("THAI") @map("owner_national_type") // THAI or FOREIGNER
  ownerNationalId       String? @map("owner_national_id") // Thai ID: 1770500036961
  ownerPassportNumber   String? @map("owner_passport_number") // For foreigners
  ownerFirstName        String  @map("owner_first_name") // ‡∏§‡∏î‡∏µ‡∏Å‡∏£
  ownerMiddleName       String? @map("owner_middle_name")
  ownerLastName         String  @map("owner_last_name") // ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÄ‡∏Å‡∏¥‡∏î
  ownerTelephone        String  @map("owner_telephone") // 0986261646
  ownerGender           String? @map("owner_gender") // M/F

  // ============================================
  // TYPE & HOUSE ID (from ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô)
  // ============================================
  entityType    String  @default("INDIVIDUAL") @map("entity_type") // INDIVIDUAL or JURISTIC
  houseIdNumber String? @map("house_id_number") // ‡πÄ‡∏•‡∏Ç‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ö‡πâ‡∏≤‡∏ô: S392-013427-3

  // ============================================
  // ACCOMMODATIE DETAILS
  // ============================================
  accommodationType String  @map("accommodation_type") // Dropdown value
  accommodationName String  @map("accommodation_name") // e.g., "PHUKET: New Villa Name"
  position          String? // Dropdown: Owner, Manager, etc.
  positionOther     String? @map("position_other") // If position is "Other"

  // ============================================
  // ADRES (from ‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô)
  // ============================================
  addressNumber String  @map("address_number") // ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: 46/27
  villageNumber String? @map("village_number") // ‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà: 4
  alley         String? // ‡∏ã‡∏≠‡∏¢
  road          String? // ‡∏ñ‡∏ô‡∏ô
  province      String // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î: PHUKET
  district      String // ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: Mueang Phuket
  subDistrict   String  @map("sub_district") // ‡∏ï‡∏≥‡∏ö‡∏•: Rawai
  postalCode    String  @map("postal_code") // ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå: 83130
  latitude      Float? // Optional
  longitude     Float? // Optional

  // ============================================
  // REFERENCE DOCUMENTS (uploaded files)
  // ============================================
  houseRegistrationUrl  String? @map("house_registration_url") // ‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô
  houseRegistrationPath String? @map("house_registration_path") // Path in storage

  // ============================================
  // OCR DATA (from ChatGPT Vision)
  // ============================================
  ocrProcessed   Boolean   @default(false) @map("ocr_processed")
  ocrProcessedAt DateTime? @map("ocr_processed_at")
  ocrRawData     Json?     @map("ocr_raw_data") // Full OCR response
  ocrConfidence  Float?    @map("ocr_confidence") // 0-1 confidence score

  // ============================================
  // SUBMISSION STATUS
  // ============================================
  status          Tm30AccomRequestStatus @default(DRAFT)
  tm30Id          String?                @map("tm30_id") // Assigned after approval: 7521-XXXXX
  submittedAt     DateTime?              @map("submitted_at")
  approvedAt      DateTime?              @map("approved_at")
  rejectedAt      DateTime?              @map("rejected_at")
  rejectionReason String?                @map("rejection_reason")
  errorMessage    String?                @map("error_message")

  // ============================================
  // LINK TO PROPERTY (after approved)
  // ============================================
  propertyId String? @unique @map("property_id")

  // ============================================
  // LINK TO PROPERTY OWNER (central owner system)
  // ============================================
  propertyOwnerId String?        @map("property_owner_id")
  propertyOwner   PropertyOwner? @relation("RequestOwner", fields: [propertyOwnerId], references: [id])

  // ============================================
  // WHATSAPP TRACKING
  // ============================================
  whatsappPhone     String? @map("whatsapp_phone")
  whatsappSessionId String? @map("whatsapp_session_id")

  // ============================================
  // AUDIT
  // ============================================
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([propertyId])
  @@index([propertyOwnerId])
  @@index([houseIdNumber])
  @@index([whatsappPhone])
  @@map("tm30_accommodation_request")
}

enum Tm30AccomRequestStatus {
  DRAFT // Nog niet klaar om te submiten
  PENDING // Wacht op automatisering
  PROCESSING // Playwright is bezig
  SUBMITTED // Ingediend bij TM30, wacht op goedkeuring
  APPROVED // Goedgekeurd door TM30
  REJECTED // Afgewezen door TM30
  FAILED // Technische fout
}

// ============================================
// PROPERTY OWNER SYSTEM
// Central owner entity for document management
// ============================================

model PropertyOwner {
  id String @id @default(cuid())

  // Personal Information (from ID Card OCR)
  firstName    String  @map("first_name")
  lastName     String  @map("last_name")
  thaiIdNumber String? @unique @map("thai_id_number") // From ID card OCR
  phone        String  @unique // WhatsApp number - primary lookup
  email        String?
  gender       String? // Male/Female

  // ID Card (1 per owner - reusable across properties)
  idCardUrl        String?   @map("id_card_url")
  idCardPath       String?   @map("id_card_path") // "owners/{id}/id-card.jpg"
  idCardOcrData    Json?     @map("id_card_ocr_data")
  idCardVerified   Boolean   @default(false) @map("id_card_verified")
  idCardUploadedAt DateTime? @map("id_card_uploaded_at")

  // Status
  isActive   Boolean @default(true) @map("is_active")
  isVerified Boolean @default(false) @map("is_verified") // Admin verified

  // Relations
  documents    OwnerDocument[]
  properties   Property[]                 @relation("PropertyOwner")
  tm30Requests Tm30AccommodationRequest[] @relation("RequestOwner")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([phone])
  @@index([thaiIdNumber])
  @@index([lastName])
  @@map("property_owner")
}

model OwnerDocument {
  id String @id @default(cuid())

  // Owner relation
  ownerId String        @map("owner_id")
  owner   PropertyOwner @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  // Document type
  documentType OwnerDocumentType @map("document_type")

  // File storage
  imageUrl  String  @map("image_url")
  imagePath String  @map("image_path") // "owners/{ownerId}/bluebook-{propertyId}.jpg"
  fileName  String? @map("file_name")

  // OCR Data
  ocrData        Json?     @map("ocr_data")
  ocrProcessedAt DateTime? @map("ocr_processed_at")
  ocrConfidence  Float?    @map("ocr_confidence")

  // For Bluebook: link to specific property
  propertyId String? @unique @map("property_id")

  // Extracted data (for quick access)
  houseId          String? @map("house_id") // From bluebook: "123/45"
  extractedAddress String? @map("extracted_address") @db.Text

  // Status
  isVerified Boolean   @default(false) @map("is_verified")
  verifiedBy String?   @map("verified_by")
  verifiedAt DateTime? @map("verified_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([ownerId])
  @@index([documentType])
  @@index([propertyId])
  @@map("owner_document")
}

enum OwnerDocumentType {
  ID_CARD // Thai ID Card (‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô)
  BLUEBOOK // House Registration (‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô)
  PASSPORT // Owner passport (for foreigners)
  BUSINESS_REG // Business registration
  OTHER
}

// ============================================
// WHATSAPP SESSION FOR OWNER FLOW
// ============================================

model WhatsappListingSession {
  id String @id @default(cuid())

  // Contact info
  phone String @unique

  // Current status in flow
  status String @default("IDLE")

  // Current action being performed
  currentAction String? @map("current_action")

  // Owner relation (once identified)
  ownerId String? @map("owner_id")

  // Property being registered
  currentPropertyId String? @map("current_property_id")

  // TM30 Registration Flow Data
  tm30RequestId         String? @map("tm30_request_id")
  tm30OwnerFirstName    String? @map("tm30_owner_first_name")
  tm30OwnerLastName     String? @map("tm30_owner_last_name")
  tm30OwnerGender       String? @map("tm30_owner_gender")
  tm30OwnerPhone        String? @map("tm30_owner_phone")
  tm30ThaiIdNumber      String? @map("tm30_thai_id_number")
  tm30IdCardUrl         String? @map("tm30_id_card_url")
  tm30BluebookUrl       String? @map("tm30_bluebook_url")
  tm30HouseId           String? @map("tm30_house_id")
  tm30Province          String? @map("tm30_province")
  tm30District          String? @map("tm30_district")
  tm30SubDistrict       String? @map("tm30_sub_district")
  tm30AddressNumber     String? @map("tm30_address_number")
  tm30PostalCode        String? @map("tm30_postal_code")
  tm30AccommodationName String? @map("tm30_accommodation_name")

  // Temporary storage for pending data
  pendingData Json? @map("pending_data")

  // Last activity
  lastMessageAt DateTime @default(now()) @map("last_message_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([phone])
  @@index([status])
  @@index([ownerId])
  @@map("whatsapp_listing_session")
}

// ============================================
// AUTONOMOUS AI AGENT SYSTEM
// Self-improving AI that makes decisions to maximize revenue
// ============================================

// AI Agent Configuration - Controls agent behavior
model AIAgentConfig {
  id String @id @default("default")

  // Agent Status
  enabled        Boolean @default(true)
  autonomousMode Boolean @default(false) // Auto-execute decisions without approval

  // Thresholds
  minConfidenceThreshold Float @default(80) // Min confidence (0-100) for auto-execute
  dailyDecisionLimit     Int   @default(20) // Max decisions per day
  dailyAutoExecuteLimit  Int   @default(5) // Max auto-executes per day

  // Notifications
  notifyOnDecision    Boolean @default(true)
  notifyOnAutoExecute Boolean @default(true)
  notifyEmail         String?

  // Allowed autonomous actions (JSON array of action types)
  allowedAutonomousTypes String @default("[]") @db.Text

  // Forbidden patterns (never touch these files/features)
  forbiddenPatterns String @default("[]") @db.Text

  // Learning settings
  learningEnabled  Boolean @default(true)
  feedbackLoopDays Int     @default(7) // Days to wait before measuring impact

  // Emergency controls
  killSwitch  Boolean   @default(false) // Emergency stop all AI actions
  pausedUntil DateTime?
  pauseReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ai_agent_config")
}

// AI Decisions - Every decision the AI makes
model AIDecision {
  id String @id @default(cuid())

  // Decision classification
  type     String // CONTENT_CREATION, BUG_FIX, SEO_OPTIMIZATION, etc.
  subType  String? // More specific: NEW_BLOG, FIX_MOBILE, etc.
  priority String // critical, high, medium, low

  // AI Analysis
  confidence   Float // 0-100 confidence score
  reasoning    String @db.Text // AI's reasoning for this decision
  dataSnapshot Json? // Data that triggered this decision

  // Proposed Action
  actionType      String // What kind of action to take
  actionPayload   Json // Details of the action (files to create, etc.)
  estimatedImpact String? @db.Text // Expected outcome
  rollbackPlan    String? @db.Text // How to undo this change

  // Approval workflow
  requiresApproval Boolean          @default(true)
  autoApproved     Boolean          @default(false)
  status           AIDecisionStatus @default(PENDING)

  // Approval tracking
  approvedBy      String?
  approvedByName  String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedByName  String?
  rejectedAt      DateTime?
  rejectionReason String?   @db.Text

  // Execution tracking
  executedAt        DateTime?
  executionResult   Json? // Result after execution
  executionError    String?   @db.Text
  executionDuration Int? // Milliseconds

  // Rollback tracking
  rolledBackAt   DateTime?
  rolledBackBy   String?
  rollbackReason String?

  // Feedback loop - measure actual impact
  feedbackDueAt DateTime? // When to check if this worked
  actualImpact  Json? // Measured results
  wasSuccessful Boolean? // Did it achieve the goal?
  successScore  Float? // 0-100 how well it worked
  feedbackNotes String?   @db.Text

  // Relations
  codeChanges AICodeChange[]
  logs        AIAgentLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([feedbackDueAt])
  @@map("ai_decision")
}

enum AIDecisionStatus {
  PENDING // Waiting for approval
  APPROVED // Approved, ready to execute
  EXECUTING // Currently being executed
  EXECUTED // Successfully executed
  FAILED // Execution failed
  REJECTED // Rejected by admin
  ROLLED_BACK // Was executed but rolled back
  CANCELLED // Cancelled before execution
}

// AI Code Changes - Track every file change made by AI
model AICodeChange {
  id String @id @default(cuid())

  decisionId String     @map("decision_id")
  decision   AIDecision @relation(fields: [decisionId], references: [id], onDelete: Cascade)

  // File information
  filePath String       @map("file_path")
  action   AICodeAction

  // Content
  originalContent String? @map("original_content") @db.Text // For rollback
  newContent      String? @map("new_content") @db.Text
  diff            String? @db.Text // Git-style diff

  // Validation
  syntaxValid Boolean  @default(true) @map("syntax_valid")
  typesValid  Boolean  @default(true) @map("types_valid")
  lintPassed  Boolean  @default(true) @map("lint_passed")
  testsPassed Boolean? @map("tests_passed")

  // Execution
  appliedAt    DateTime? @map("applied_at")
  rolledBackAt DateTime? @map("rolled_back_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([decisionId])
  @@index([filePath])
  @@map("ai_code_change")
}

enum AICodeAction {
  CREATE
  MODIFY
  DELETE
}

// AI Agent Logs - Detailed logging of all agent activities
model AIAgentLog {
  id String @id @default(cuid())

  // Log classification
  level    AILogLevel @default(INFO)
  category String // analysis, decision, execution, error, feedback

  // Content
  message String @db.Text
  data    Json? // Additional structured data

  // Context
  decisionId String?     @map("decision_id")
  decision   AIDecision? @relation(fields: [decisionId], references: [id], onDelete: SetNull)

  // Error details
  errorCode  String? @map("error_code")
  errorStack String? @map("error_stack") @db.Text

  // Performance
  durationMs Int? @map("duration_ms")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([level])
  @@index([category])
  @@index([decisionId])
  @@index([createdAt])
  @@map("ai_agent_log")
}

enum AILogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}

// AI Data Snapshots - Periodic snapshots of key metrics for AI analysis
model AIDataSnapshot {
  id String @id @default(cuid())

  snapshotType String // daily, weekly, monthly, triggered

  // Traffic & Views
  totalViews         Int    @default(0) @map("total_views")
  uniqueVisitors     Int    @default(0) @map("unique_visitors")
  bounceRate         Float? @map("bounce_rate")
  avgSessionDuration Float? @map("avg_session_duration")

  // Leads & Conversions
  totalInquiries  Int    @default(0) @map("total_inquiries")
  viewingRequests Int    @default(0) @map("viewing_requests")
  investorLeads   Int    @default(0) @map("investor_leads")
  rentalLeads     Int    @default(0) @map("rental_leads")
  conversionRate  Float? @map("conversion_rate")

  // Properties
  totalProperties  Int    @default(0) @map("total_properties")
  activeListings   Int    @default(0) @map("active_listings")
  newListings      Int    @default(0) @map("new_listings")
  avgPropertyViews Float? @map("avg_property_views")

  // Content
  totalBlogs     Int    @default(0) @map("total_blogs")
  publishedBlogs Int    @default(0) @map("published_blogs")
  avgBlogViews   Float? @map("avg_blog_views")

  // SEO
  organicTraffic Int?   @map("organic_traffic")
  topKeywords    Json?  @map("top_keywords")
  avgPosition    Float? @map("avg_position")

  // Revenue indicators
  estimatedLeadValue Float? @map("estimated_lead_value")

  // Errors & Issues
  errorCount  Int   @default(0) @map("error_count")
  slowPages   Json? @map("slow_pages")
  brokenLinks Int   @default(0) @map("broken_links")

  // Full data for AI analysis
  rawData Json? @map("raw_data")

  // Period
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([snapshotType])
  @@index([periodStart])
  @@index([createdAt])
  @@map("ai_data_snapshot")
}

// AI Improvement Opportunities - Identified opportunities for improvement
model AIOpportunity {
  id String @id @default(cuid())

  // Classification
  type    String // content_gap, bug, performance, seo, conversion, feature
  subType String?

  // Details
  title       String
  description String @db.Text
  trigger     String // What data triggered this opportunity

  // Priority calculation
  priority        Int    @default(5) // 1-10, higher = more important
  estimatedEffort String // small, medium, large
  estimatedImpact String // low, medium, high

  // Revenue potential
  potentialRevenue Float? @map("potential_revenue")
  potentialLeads   Int?   @map("potential_leads")

  // Status
  status AIOpportunityStatus @default(IDENTIFIED)

  // Decision link
  decisionId String? @unique @map("decision_id")

  // Tracking
  identifiedAt DateTime  @default(now()) @map("identified_at")
  addressedAt  DateTime? @map("addressed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([type])
  @@index([status])
  @@index([priority])
  @@map("ai_opportunity")
}

enum AIOpportunityStatus {
  IDENTIFIED // Just discovered
  ANALYZING // AI is analyzing deeper
  DECISION_MADE // Decision created
  IN_PROGRESS // Being worked on
  COMPLETED // Successfully addressed
  DISMISSED // Not worth pursuing
}

// AI Learning History - Track what the AI learns from its decisions
model AILearning {
  id String @id @default(cuid())

  // What was learned
  category String // decision_making, code_quality, user_behavior, etc.
  insight  String @db.Text

  // Source decision
  sourceDecisionId String? @map("source_decision_id")

  // Confidence in this learning
  confidence Float // 0-100

  // How this affects future decisions
  impactArea String // What aspect of decision-making this affects
  adjustment String @db.Text // How to adjust future behavior

  // Validation
  validatedBy String?   @map("validated_by")
  validatedAt DateTime? @map("validated_at")
  isValid     Boolean   @default(true) @map("is_valid")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([category])
  @@index([sourceDecisionId])
  @@map("ai_learning")
}

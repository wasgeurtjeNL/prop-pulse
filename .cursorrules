# PSM Phuket - Cursor AI Rules

This is a Next.js 16 real estate platform focused on SEO and performance.

**IMPORTANT: All code, comments, and UI text should be in English unless otherwise specified.**

## üö´ Important Restrictions

- **NEVER** run `npm run dev` - the user starts this themselves
- **NEVER** create new functions/APIs if existing ones exist - ALWAYS search for existing implementations first
- **NEVER** ignore TypeScript errors - all types must be correct

---

## üöÄ Deployment

### ‚ö†Ô∏è Vercel CLI Only - NO GitHub
- Deploy **exclusively** via `vercel --prod`
- Do **NOT** use git push, GitHub, or any git remotes
- Local commits are fine for tracking, but deployment = Vercel CLI

### Database Migrations (Prisma)
- **Local database**: `npx prisma db push` and `npx prisma generate`
- **Production database**: Use **Supabase MCP** to push schema changes
- For new models/fields:
  1. Update `prisma/schema.prisma`
  2. Push to production via `mcp_supabase_apply_migration`
  3. Generate types locally with `npx prisma generate`

### Test Workflow (MCP Playwright)
Before deploying, test the changes:
```
1. mcp_cursor-ide-browser_browser_navigate ‚Üí Navigate to the page
2. mcp_cursor-ide-browser_browser_snapshot ‚Üí View the elements
3. mcp_cursor-ide-browser_browser_click/type ‚Üí Test interactions
4. Check console/network errors if needed
```

---

## üìÇ Project Structure & Conventions

### Tech Stack
- **Framework**: Next.js 16 (App Router)
- **React**: 19
- **Database**: Prisma with PostgreSQL  
- **Auth**: Better Auth
- **Styling**: Tailwind CSS 4
- **Images**: ImageKit.io
- **Animations**: Framer Motion

### Folder Structure
```
app/
  (front)/       ‚Üí Public pages
  (dashboard)/   ‚Üí Admin dashboard
  api/           ‚Üí API routes
components/
  ui/            ‚Üí Base UI components (shadcn/ui)
  new-design/    ‚Üí Feature-specific components
  shared/        ‚Üí Reusable components
lib/
  actions/       ‚Üí Server Actions (CRUD operations)
  utils/         ‚Üí Utility functions
  validations/   ‚Üí Zod schemas
```

### URL Structure
```
/properties                           ‚Üí Property listing
/properties/[province]/[area]/[slug]  ‚Üí Property detail (SEO-optimized)
/listings/[slug]                      ‚Üí Property detail (slug-only fallback)
```
- Use `/listings/:slug` for redirects (no province/area needed)
- Use `/properties/[province]/[area]/[slug]` for internal links (SEO)

---

## üîÑ Reusing Existing Code

### ALWAYS check if functionality already exists:

#### Server Actions (lib/actions/)
- `blog.actions.ts` - Blog CRUD operations
- `property.actions.ts` - Property CRUD operations  
- `upload.actions.ts` - File upload to ImageKit
- `user.actions.ts` - User management

#### Utility Functions (lib/)
- `lib/utils.ts` - `cn()`, `formatType()`, `getUserInitials()`, `slugify()`
- `lib/url.ts` - URL helpers
- `lib/validation.ts` - Validation helpers
- `lib/imagekit.ts` - ImageKit configuration

#### SEO Utils (lib/utils/)
- `structured-data.ts` - Schema.org JSON-LD generators:
  - `generatePropertySchema()` - For property pages
  - `generateOrganizationSchema()` - For business info
  - `generateBreadcrumbSchema()` - For breadcrumbs
  - `generateFAQSchema()` - For FAQ sections
  - `generateArticleSchema()` - For blog posts
  - `renderJsonLd()` - Helper for script rendering

#### UI Components (components/ui/)
ALWAYS use the existing shadcn/ui components:
- Button, Card, Input, Select, Dialog, Form, etc.

---

## üöÄ Performance & PageSpeed Optimization

### Images
```tsx
// ‚úÖ GOOD - Use Next.js Image with optimization
import Image from 'next/image'

<Image 
  src={url}
  alt="Descriptive alt text"  // ALWAYS add alt text for SEO
  width={800}
  height={600}
  loading="lazy"                  // Lazy load for below-the-fold
  priority                        // Only for above-the-fold images
  sizes="(max-width: 768px) 100vw, 50vw"  // Responsive sizes
  quality={75}                    // Balance between quality and size
  placeholder="blur"              // Blur placeholder for better UX
/>
```

### Code Splitting & Lazy Loading
```tsx
// ‚úÖ GOOD - Dynamic imports for heavy components
import dynamic from 'next/dynamic'

const HeavyComponent = dynamic(() => import('./HeavyComponent'), {
  loading: () => <Skeleton />,
  ssr: false  // If not needed for SEO
})
```

### Server vs Client Components
```tsx
// Default = Server Component (better for SEO & performance)
// Use 'use client' ONLY when needed:
// - Event handlers (onClick, onChange, etc.)
// - useState, useEffect, other hooks
// - Browser APIs (window, document)
```

### Fonts
```tsx
// ‚úÖ GOOD - Use next/font for optimal loading
import { Inter } from 'next/font/google'
const inter = Inter({ subsets: ['latin'], display: 'swap' })
```

### Caching & Revalidation
```tsx
// In Server Components / fetch calls
fetch(url, { 
  next: { 
    revalidate: 3600  // Cache for 1 hour
  }
})

// For static pages
export const revalidate = 3600
```

---

## üîç SEO Best Practices

### Metadata (Every page MUST have this)
```tsx
import { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'Page Title | PSM Phuket',
  description: 'Unique description of 150-160 characters...',
  keywords: ['real estate', 'phuket', 'investing'],
  openGraph: {
    title: 'Title for social media',
    description: 'Description for social media',
    images: ['/og-image.jpg'],
    type: 'website',
  },
  twitter: {
    card: 'summary_large_image',
  },
  alternates: {
    canonical: 'https://psmphuket.com/page',
  },
}

// OR dynamically:
export async function generateMetadata({ params }): Promise<Metadata> {
  // Fetch data and return metadata
}
```

### Structured Data (JSON-LD)
```tsx
// Import existing helpers!
import { 
  generatePropertySchema, 
  generateBreadcrumbSchema,
  renderJsonLd 
} from '@/lib/utils/structured-data'

// In your component:
<script
  type="application/ld+json"
  dangerouslySetInnerHTML={renderJsonLd(generatePropertySchema({
    name: property.title,
    price: property.price,
    // ... etc
  }))}
/>
```

### Semantic HTML
```tsx
// ‚úÖ GOOD - Use semantic elements
<header>...</header>
<main>...</main>
<article>...</article>
<section>...</section>
<nav>...</nav>
<footer>...</footer>
<h1>...</h1>  // Only 1 per page!
```

### Links
```tsx
// ‚úÖ GOOD - Internal links
import Link from 'next/link'
<Link href="/properties" prefetch>Properties</Link>

// ‚úÖ GOOD - External links
<a href="https://..." target="_blank" rel="noopener noreferrer">
```

---

## üíæ Database (Prisma)

### ‚ö†Ô∏è TWO DATABASES - Local vs Supabase MCP

**CRITICAL: The project uses TWO different database connections!**

| Connection | Used By | Database |
|------------|---------|----------|
| `DATABASE_URL` in `.env` | Next.js app, Prisma, API routes | Local PostgreSQL (`127.0.0.1:5432`) |
| MCP Supabase tools | `mcp_supabase_*` commands in Cursor | Supabase cloud database |

**This means:**
- ‚ùå Data added via `mcp_supabase_execute_sql` is NOT visible to the Next.js app
- ‚ùå Data added via Prisma/Next.js is NOT visible in MCP Supabase queries
- ‚úÖ Always seed/migrate BOTH databases when needed

**How to sync:**
```bash
# For LOCAL database (Next.js app uses this):
npx prisma db push                    # Push schema
npx tsx prisma/seed-[name].ts         # Run seed scripts

# For SUPABASE (MCP tools use this):
mcp_supabase_apply_migration          # Push schema
mcp_supabase_execute_sql              # Insert data
```

**Quick check which DB you're working with:**
- Using `prisma.*` or API routes ‚Üí Local DB
- Using `mcp_supabase_*` ‚Üí Supabase cloud

### ‚ö†Ô∏è User Roles - ALWAYS UPPERCASE

User roles in the database MUST always be in **UPPERCASE**:
- ‚úÖ `ADMIN` (not `admin`)
- ‚úÖ `AGENT` (not `agent`)

The dashboard access control checks for: `["AGENT", "ADMIN"]`

```sql
-- Check user roles:
SELECT id, email, role FROM public.user;

-- Fix role to uppercase:
UPDATE public.user SET role = 'ADMIN' WHERE email = 'user@example.com';
```

**NEVER** adjust the role check code to lowercase - always fix the database value!

### ‚ö†Ô∏è For Database Errors - FIRST Diagnose, THEN Fix

For Prisma errors like "Server has closed the connection" (P1017):

1. **NEVER immediately adjust code** - First check the configuration!
2. **Check DATABASE_URL in .env**:
   - Use `127.0.0.1` instead of `localhost` (IPv6/IPv4 issues on Windows)
   - Check the port (Supabase local = `5432`, not `5433`)
   - Check the database name
3. **Check Docker containers**:
   ```bash
   docker ps --filter "name=supabase" --format "table {{.Names}}\t{{.Ports}}"
   ```
4. **Test database reachability**:
   ```bash
   docker exec supabase_db_my-platform psql -U postgres -c "SELECT 1;"
   ```
5. **After .env changes**: 
   - Restart dev server
   - `npx prisma db push` if tables are missing

### Correct DATABASE_URL format (local Supabase):
```
DATABASE_URL="postgresql://postgres:postgres@127.0.0.1:5432/real_estate_pulse"
```

### ‚ö†Ô∏è Model & Field Naming Convention - CRITICAL

The Prisma schema uses **snake_case** for model names and some field names. ALWAYS check `schema.prisma` for the correct naming!

```tsx
// ‚ùå WRONG - camelCase model names don't exist
await prisma.rentalBooking.findMany()
await prisma.bookingGuest.update()
await prisma.bookingMessage.create()

// ‚úÖ CORRECT - Use snake_case as defined in schema
await prisma.rental_booking.findMany()
await prisma.booking_guest.update()
await prisma.booking_message.create()

// ‚ùå WRONG - camelCase field names for snake_case schema fields
data: {
  passportImageUrl: url,
  tm30Status: "PENDING",
  guestNumber: 1,
}

// ‚úÖ CORRECT - Use snake_case field names
data: {
  passport_image_url: url,
  tm30_status: "PENDING",
  guest_number: 1,
}
```

**Models with snake_case names:**
- `rental_booking` (NOT rentalBooking)
- `booking_guest` (NOT bookingGuest)
- `booking_message` (NOT bookingMessage)
- `rental_pricing_config` (NOT rentalPricingConfig)
- `property_blocked_date` (NOT propertyBlockedDate)

**‚ö†Ô∏è Mixed naming in `rental_booking`:**
The `rental_booking` model has BOTH camelCase AND snake_case fields!

```tsx
// camelCase fields (use as-is):
checkIn, checkOut, guestName, guestEmail, guestPhone, 
basePrice, totalPrice, nights, adults, children, babies, pets,
status, userId, propertyId, createdAt, updatedAt,
cancellationPolicy, cancelledAt, cancellationReason, internalNotes

// snake_case fields (must use snake_case):
check_in_time, check_out_time, property_address, property_instructions,
wifi_name, wifi_password, access_code, emergency_contact, house_rules,
confirmed_at, agent_id, passports_received, passports_required,
tm30_status, tm30_error, tm30_reference, tm30_submitted_at
```

**When returning data to frontend:** Map snake_case back to camelCase for API responses:
```tsx
return NextResponse.json({
  guest: {
    firstName: dbGuest.first_name,  // Map for frontend
    passportNumber: dbGuest.passport_number,
  }
});
```

### Queries
```tsx
// ‚úÖ GOOD - Select only what you need
const properties = await prisma.property.findMany({
  select: {
    id: true,
    title: true,
    slug: true,
    // Don't fetch the entire entity if you don't need everything
  },
  take: 10,  // Limit results
})

// ‚úÖ GOOD - Use includes efficiently
const property = await prisma.property.findUnique({
  where: { slug },
  include: {
    images: {
      select: { url: true, alt: true },
      take: 5,
    },
  },
})
```

### Server Actions Pattern
```tsx
// In lib/actions/[entity].actions.ts
'use server'

export async function getProperties(filters: PropertyFilters) {
  try {
    const properties = await prisma.property.findMany({...})
    return { success: true, data: properties }
  } catch (error) {
    console.error('Error:', error)
    return { success: false, error: 'Error fetching properties' }
  }
}
```

---

## üé® Styling Conventions

### Tailwind Classes
```tsx
// ‚úÖ GOOD - Use cn() for conditional classes
import { cn } from '@/lib/utils'

<div className={cn(
  'base-classes',
  isActive && 'active-classes',
  className  // Pass through props
)}>
```

### Responsive Design
```tsx
// Mobile-first approach
<div className="
  px-4 py-2           // Mobile (default)
  md:px-6 md:py-4     // Tablet
  lg:px-8 lg:py-6     // Desktop
">
```

---

## üì± Mobile Responsive - CRITICAL RULES

### ‚ö†Ô∏è NEVER use translate-x-full without visibility/display control

Off-screen elements (like side menus) that only use `translate-x-full` cause **horizontal overflow** and white space on mobile!

```tsx
// ‚ùå WRONG - Causes horizontal overflow on mobile
<div className={cn(
  "fixed top-0 right-0 w-full",
  isOpen ? "translate-x-0" : "translate-x-full"  // Element still exists in document!
)}>

// ‚úÖ CORRECT - Combine translate with invisible/hidden
<div className={cn(
  "fixed top-0 right-0 w-full transition-all",
  isOpen 
    ? "translate-x-0 opacity-100 visible" 
    : "translate-x-full opacity-0 invisible pointer-events-none"
)}>
```

### Overflow Control
```css
/* In globals.css - use overflow-x: clip (stronger than hidden) */
html, body {
  overflow-x: clip;  /* Clips fixed/absolute elements too */
  max-width: 100%;
}
```

### Checklist for Off-Screen Elements
- [ ] Use `invisible` or `hidden` alongside `translate-x-full`
- [ ] Add `pointer-events-none` when hidden
- [ ] ALWAYS test on mobile viewport (< 400px)
- [ ] Check with DevTools for horizontal scroll

---

## ‚úÖ Component Checklist

When creating a new component, check:

- [ ] Does a similar component already exist?
- [ ] Server or Client component? (Server = default)
- [ ] Does it have proper TypeScript types?
- [ ] Is it responsive (mobile-first)?
- [ ] Are images optimized with next/image?
- [ ] Does it have accessibility attributes (aria-*, alt, etc.)?
- [ ] Is lazy loading applied where needed?
- [ ] **Off-screen elements**: Uses `invisible`/`hidden` alongside `translate-x-full`?

---

## üö® Code Review Checklist

Before committing code:

- [ ] No duplicate functions/APIs created
- [ ] All pages have correct metadata
- [ ] Images use next/image with alt text
- [ ] No console.log statements in production code
- [ ] TypeScript errors are resolved
- [ ] Large components are lazy loaded
- [ ] Server Components where possible
- [ ] **Mobile responsive**: No horizontal overflow (test on 375px viewport)
- [ ] **Off-screen elements**: `translate-x-full` always combined with `invisible`

---

## üìù Examples

### New Property Page (complete example)
```tsx
// app/(front)/properties/[slug]/page.tsx
import { Metadata } from 'next'
import Image from 'next/image'
import { notFound } from 'next/navigation'
import { getPropertyBySlug } from '@/lib/actions/property.actions'
import { generatePropertySchema, renderJsonLd } from '@/lib/utils/structured-data'

interface Props {
  params: Promise<{ slug: string }>
}

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { slug } = await params
  const property = await getPropertyBySlug(slug)
  
  if (!property) return { title: 'Not Found' }
  
  return {
    title: `${property.title} | PSM Phuket`,
    description: property.description?.slice(0, 160),
    openGraph: {
      images: [property.images[0]?.url || '/default-og.jpg'],
    },
  }
}

export default async function PropertyPage({ params }: Props) {
  const { slug } = await params
  const property = await getPropertyBySlug(slug)
  
  if (!property) notFound()
  
  const schema = generatePropertySchema({
    name: property.title,
    price: property.price,
    beds: property.beds,
    baths: property.baths,
    location: property.location,
    slug: property.slug,
    image: property.images.map(i => i.url),
  })
  
  return (
    <>
      <script
        type="application/ld+json"
        dangerouslySetInnerHTML={renderJsonLd(schema)}
      />
      <main>
        <h1>{property.title}</h1>
        {/* Rest of the component */}
      </main>
    </>
  )
}
```
